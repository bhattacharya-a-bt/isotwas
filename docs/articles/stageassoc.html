<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="isotwas">
<title>Run isoTWAS associations • isotwas</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run isoTWAS associations">
<meta property="og:description" content="isotwas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">isotwas</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/motivation.html">Motivation for isotwas</a>
    <a class="dropdown-item" href="../articles/pipeline.html">Train an isoTWAS model</a>
    <a class="dropdown-item" href="../articles/stageassoc.html">Run isoTWAS associations</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Run isoTWAS associations</h1>
            
      
      
      <div class="d-none name"><code>stageassoc.Rmd</code></div>
    </div>

    
    
<p>This module will cover how to use functions from <code>isotwas</code>
to map isoform-level trait associations using a two-step testing
framework. Then, we will run probabilistic fine-mapping to account of
linkage disequilibrium (LD) in a locus with overlapping isoforms that
are associated with a trait. Along the way, we’ll be covering some
practical considerations for computation and feature selection.</p>
<p>For this, you will need:</p>
<ol style="list-style-type: decimal">
<li><p>a set of isoTWAS models,</p></li>
<li><p>an appropriate LD reference panel, and</p></li>
<li><p>GWAS summary statistics for your trait of interest.</p></li>
</ol>
<p>Let’s talk a little about each of these three components.</p>
<div class="section level2">
<h2 id="pre-computed-models-and-ld-matrix">Pre-computed models and LD matrix<a class="anchor" aria-label="anchor" href="#pre-computed-models-and-ld-matrix"></a>
</h2>
<p>You can always use your own set of models that you have trained on
your own isoform expression QTL data (paired genotype and RNA-seq data).
For convenience, we have trained and made publicly available isoTWAS
models for 48 tissues from the <a href="https://gtexportal.org/home/" class="external-link">Genotype-Tissue Expression Project
(GTEx)</a>, adult brain cortex from <a href="https://www.nimhgenetics.org/resources/psychencode" class="external-link">PsychENCODE</a>
and <a href="https://www.nia.nih.gov/research/amp-ad" class="external-link">AMP-AD</a>, and
developmental brain cortex from PsychENCODE. There are Zenodo
repositories for the <a href="https://zenodo.org/record/8047940" class="external-link">GTEx</a>, <a href="https://zenodo.org/record/8048198" class="external-link">adult cortex</a>, and <a href="https://zenodo.org/record/8048137" class="external-link">developmental cortex</a>
models. Please cite our manuscript and the associated Zenodo DOI if you
use these models.</p>
<p>To download an entire Zenodo repository, you may use the Python
package <code>Zenodo_get</code> (<a href="https://zenodo.org/record/1261813" class="external-link uri">https://zenodo.org/record/1261813</a>). To install and use,
here are some sample commands to directly download all of the adult
cortex repository off Zenodo:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install zenodo-get</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">zenodo_get</span> 8048198</span></code></pre></div>
<p>In this tutorial, we are only using isoTWAS models for 3 genes:
<em>CDC42</em> (<em>ENSG00000070831</em>), <em>WNT4</em>
(<em>ENSG00000162552</em>), and <em>CDC42-IT1</em>
(<em>ENSG00000230068</em>). Let’s take a look at what the models look
like, which are saved as <code>.RDS</code> files.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1789</span><span class="op">)</span></span>
<span><span class="va">model_test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                                 <span class="st">"ENSG00000070831_isoTWAS.RDS"</span>,</span>
<span>                                 package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">model_test</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           Feature        SNP Chromosome Position Build ALT REF        Weight</span></span>
<span><span class="co">## 2 ENST00000344548 rs10917023          1 21599110  hg38   A   G  0.0257706583</span></span>
<span><span class="co">## 3 ENST00000344548 rs10917145          1 22086152  hg38   A   G -0.2503237794</span></span>
<span><span class="co">## 4 ENST00000344548 rs11584687          1 22550747  hg38   A   G  0.0200388736</span></span>
<span><span class="co">## 5 ENST00000344548 rs12082914          1 21493245  hg38   G   T  0.0167839153</span></span>
<span><span class="co">## 6 ENST00000344548 rs12118362          1 21445504  hg38   G   A  0.0133152139</span></span>
<span><span class="co">## 7 ENST00000344548 rs12127343          1 21543280  hg38   A   G  0.0007759457</span></span>
<span><span class="co">##           R2            Gene</span></span>
<span><span class="co">## 2 0.09314035 ENSG00000070831</span></span>
<span><span class="co">## 3 0.09314035 ENSG00000070831</span></span>
<span><span class="co">## 4 0.09314035 ENSG00000070831</span></span>
<span><span class="co">## 5 0.09314035 ENSG00000070831</span></span>
<span><span class="co">## 6 0.09314035 ENSG00000070831</span></span>
<span><span class="co">## 7 0.09314035 ENSG00000070831</span></span></code></pre>
<p>If you train your own models, ensure that your model files contain
columns for the:</p>
<ol style="list-style-type: decimal">
<li><p>isoform name,</p></li>
<li><p>SNP name or rsID,</p></li>
<li><p>chromosome of the SNP,</p></li>
<li><p>position of the SNP,</p></li>
<li><p>alternative allele,</p></li>
<li><p>reference allele, and</p></li>
<li><p>the predictive weight for the isoform.</p></li>
</ol>
<p>For reference, our models include the genome build on which the model
was trained, so users can align their GWAS to the models based on genome
build.</p>
<p>We also include in-sample LD matrices for each isoTWAS model. These
are simply <code>.RDS</code> files that contain a square matrix with the
LD between the SNPs in the correspondin row and column.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LD_test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                                 <span class="st">"ENSG00000070831_LDMatrix.RDS"</span>,</span>
<span>                                 package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">LD_test</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: Matrix</span></span></code></pre>
<pre><code><span><span class="co">##            rs10916927  rs6658526  rs1354792 rs12567861 rs10916930  rs7521711</span></span>
<span><span class="co">## rs10916927  1.0000000  0.9440432  0.8544395 -0.6393393 -0.6405133  0.8536513</span></span>
<span><span class="co">## rs6658526   0.9440432  1.0000000  0.8005756 -0.5896286 -0.5924963  0.7998371</span></span>
<span><span class="co">## rs1354792   0.8544395  0.8005756  1.0000000 -0.7649469 -0.7657869  0.9990775</span></span>
<span><span class="co">## rs12567861 -0.6393393 -0.5896286 -0.7649469  1.0000000  0.9971883 -0.7642413</span></span>
<span><span class="co">## rs10916930 -0.6405133 -0.5924963 -0.7657869  0.9971883  1.0000000 -0.7650804</span></span>
<span><span class="co">## rs7521711   0.8536513  0.7998371  0.9990775 -0.7642413 -0.7650804  1.0000000</span></span>
<span><span class="co">##             rs4654899   rs960564  rs6663452  rs7532667</span></span>
<span><span class="co">## rs10916927  0.9097877  0.9966544  0.9501309  0.9971286</span></span>
<span><span class="co">## rs6658526   0.8503948  0.9427488  0.8973393  0.9458899</span></span>
<span><span class="co">## rs1354792   0.9361329  0.8530981  0.8951509  0.8538566</span></span>
<span><span class="co">## rs12567861 -0.7173327 -0.6390579 -0.6724022 -0.6393520</span></span>
<span><span class="co">## rs10916930 -0.7179086 -0.6402319 -0.6737519 -0.6405219</span></span>
<span><span class="co">## rs7521711   0.9371127  0.8532494  0.8952461  0.8530689</span></span></code></pre>
<p>Note that the column and row names for the matrix correspond to the
rsIDs in the model.</p>
<p><u><strong>Practical consideration</strong></u>: In many settings,
you will not have a corresponding file that contains the LD matrix for
the SNPs at the locus. In this case, we suggest either one of two
approaches. First, you can generate the LD matrix from the data where
the model was trained, if you have access to the individual-level
genotypes for this data. Alternatively, you can use an LD reference
panel that is well-aligned to the genetic ancestry of the training
dataset. This LD reference panel is usually <a href="https://www.internationalgenome.org/" class="external-link">1000 Genomes</a>, since it’s
publicly available. You can use <code><a href="https://privefl.github.io/bigsnpr/reference/snp_cor.html" class="external-link">bigsnpr::snp_cor</a></code> or
<code><a href="https://privefl.github.io/bigsnpr/reference/snp_cor.html" class="external-link">bigsnpr::bed_cor</a></code> to generate similar-looking LD matrices,
given you have the PLINK style files
(<code>.bed</code>/<code>.bim</code>/<code>.fam</code>) for the LD
reference.</p>
</div>
<div class="section level2">
<h2 id="preparing-the-gwas-summary-statistics">Preparing the GWAS summary statistics<a class="anchor" aria-label="anchor" href="#preparing-the-gwas-summary-statistics"></a>
</h2>
<p>The last file you will need is the GWAS summary statistics for your
trait of interest. In this tutorial, we are using the GWAS summary
statistics for schizophrenia, made available by the Psychiatric Genomics
Consortium. We are specifically using the GWAS summary statistics from
European-ancestry individual. You can find these files here: <a href="https://figshare.com/articles/dataset/scz2022/19426775" class="external-link uri">https://figshare.com/articles/dataset/scz2022/19426775</a>.</p>
<p>Since GWAS summary statistics often have varied column names, we use
a munging script to clean the data. In addition, we subset the GWAS
summary statistics to only SNPs annotated in <a href="https://www.nature.com/articles/nature02168" class="external-link">HapMap3</a> to ensure
that there is maximal overlap. This munging script is available <a href="https://github.com/bhattacharya-a-bt/isotwas_manu_scripts/blob/98a76279037003e0e30de964b26fe7d5a49961df/Real%20Data/Association%20Testing/MungeSumStats/Snakefile" class="external-link">here</a>,
courtesy of Michael Margolis.</p>
<p>In this tutorial, we have subsetted only to the SNPs that are within
the <em>SCN2A</em>/<em>SCN3A</em> locus. Let’s take a look at this
munged file.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gwas</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                              <span class="st">"tutorial_SCZ_2022.hm3_filter.sumstats.gz"</span>,</span>
<span>                              package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span>,</span>
<span>                  header<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gwas</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          SNP A1 A2      Z        N</span></span>
<span><span class="co">## 1 rs10916927  T  C  3.108 146347.8</span></span>
<span><span class="co">## 2  rs6658526  C  T  2.954 146347.8</span></span>
<span><span class="co">## 3  rs1354792  T  C  1.636 146347.8</span></span>
<span><span class="co">## 4 rs12567861  C  T -1.641 146347.8</span></span>
<span><span class="co">## 5 rs10916930  T  C -1.684 146347.8</span></span>
<span><span class="co">## 6  rs7521711  A  G  1.627 146347.8</span></span></code></pre>
<p>This munged summary statistics table has only 5 columns:</p>
<ol style="list-style-type: decimal">
<li><p>The SNP rsID,</p></li>
<li><p>the alternative allele,</p></li>
<li><p>the reference allele,</p></li>
<li><p>the Z-score (beta value divided by standard error) for the GWAS
association, and</p></li>
<li><p>the effective sample size.</p></li>
</ol>
<p>We advise you use the munging script to format your summary
statistics files. At the very least, please ensure that your summary
statistics file contains a column for the SNP identifier, the
alternative allele, and either the Z-score or the beta value and
standard error for each SNP.</p>
</div>
<div class="section level2">
<h2 id="generating-nominal-z-scores">Generating nominal Z-scores<a class="anchor" aria-label="anchor" href="#generating-nominal-z-scores"></a>
</h2>
<p>The first step for isoTWAS trait-mapping is to generate the
isoform-level Z-scores using the weighted burden test. In general,
you’ll have a vector of gene names with corresponding isoTWAS model
files and/or LD files. The following code snippet loops through this
vector of genes, reads in the model file and LD file, and then computes
a Z-score for each isoform of the gene that was well-predicted in
cross-validation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ENSG00000070831'</span>,</span>
<span>               <span class="st">'ENSG00000162552'</span>,</span>
<span>               <span class="st">'ENSG00000230068'</span><span class="op">)</span></span>
<span><span class="va">out_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Gene <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    Feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    permute.P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    topSNP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    topSNP.P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gene</span> <span class="kw">in</span> <span class="va">gene_names</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">gene</span>,<span class="st">"_isoTWAS.RDS"</span><span class="op">)</span>,</span>
<span>                              package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ld</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">gene</span>,<span class="st">"_LDMatrix.RDS"</span><span class="op">)</span>,</span>
<span>                           package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">tx</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">Feature</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">sumstats.cur</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">gwas</span>,<span class="va">SNP</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">Feature</span> <span class="op">==</span> <span class="va">tx</span><span class="op">)</span><span class="op">$</span><span class="va">SNP</span><span class="op">)</span></span>
<span>    <span class="va">tx_df</span> <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/burdenTest.html">burdenTest</a></span><span class="op">(</span>mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">Feature</span> <span class="op">==</span> <span class="va">tx</span><span class="op">)</span>,</span>
<span>                       ld <span class="op">=</span> <span class="va">ld</span>,</span>
<span>                       gene <span class="op">=</span> <span class="va">gene</span>,</span>
<span>                       sumStats <span class="op">=</span> <span class="va">sumstats.cur</span>,</span>
<span>                       chr <span class="op">=</span> <span class="st">'Chromosome'</span>,</span>
<span>                       pos <span class="op">=</span> <span class="st">'Position'</span>,</span>
<span>                       a1 <span class="op">=</span> <span class="st">'A1'</span>,</span>
<span>                       a2 <span class="op">=</span> <span class="st">'A2'</span>,</span>
<span>                       a1_mod <span class="op">=</span> <span class="st">'ALT'</span>,</span>
<span>                       a2_mod <span class="op">=</span> <span class="st">'REF'</span>,</span>
<span>                       snpName <span class="op">=</span> <span class="st">'SNP'</span>,</span>
<span>                       Z <span class="op">=</span> <span class="st">'Z'</span>,</span>
<span>                       beta <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       se <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       featureName <span class="op">=</span> <span class="st">'Feature'</span>,</span>
<span>                       R2cutoff <span class="op">=</span> <span class="fl">.01</span>,</span>
<span>                       alpha <span class="op">=</span> <span class="fl">1e-3</span>,</span>
<span>                       nperms <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                       usePos <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span>    <span class="va">out_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">out_df</span>,<span class="va">tx_df</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Registered S3 methods overwritten by 'huge':</span></span>
<span><span class="co">##   method    from</span></span>
<span><span class="co">##   plot.roc  pROC</span></span>
<span><span class="co">##   plot.sim  lava</span></span>
<span><span class="co">##   print.roc pROC</span></span>
<span><span class="co">##   print.sim lava</span></span></code></pre>
<pre><code><span><span class="co">## Registered S3 methods overwritten by 'spls':</span></span>
<span><span class="co">##   method         from </span></span>
<span><span class="co">##   predict.splsda caret</span></span>
<span><span class="co">##   print.splsda   caret</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">out_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              Gene         Feature         Z            P  permute.P     topSNP</span></span>
<span><span class="co">## 1 ENSG00000070831 ENST00000344548 -3.239210 0.0011986108 1.00000000  rs2143103</span></span>
<span><span class="co">## 2 ENSG00000070831 ENST00000315554  1.268410 0.2046514827 1.00000000 rs11582542</span></span>
<span><span class="co">## 3 ENSG00000070831 ENST00000656825  3.268385 0.0010816323 1.00000000 rs11582542</span></span>
<span><span class="co">## 4 ENSG00000070831 ENST00000498236 -2.906460 0.0036554386 1.00000000 rs11582542</span></span>
<span><span class="co">## 5 ENSG00000070831 ENST00000400259  3.344840 0.0008232993 0.01198801 rs11582542</span></span>
<span><span class="co">## 6 ENSG00000070831 ENST00000667384  0.575199 0.5651567515 1.00000000 rs11582542</span></span>
<span><span class="co">##       topSNP.P</span></span>
<span><span class="co">## 1 0.0004331767</span></span>
<span><span class="co">## 2 0.0003396706</span></span>
<span><span class="co">## 3 0.0003396706</span></span>
<span><span class="co">## 4 0.0003396706</span></span>
<span><span class="co">## 5 0.0003396706</span></span>
<span><span class="co">## 6 0.0003396706</span></span></code></pre>
<p>The <code>out_df</code> variable contains a data frame with 7
columns:</p>
<ol style="list-style-type: decimal">
<li><p>the gene name,</p></li>
<li><p>the isoform name,</p></li>
<li><p>the isoform-level Z-score for the trait association,</p></li>
<li><p>the P-value corresponding to this Z-score,</p></li>
<li><p>the permutation P-value (more on this below),</p></li>
<li><p>the top SNP based on GWAS P-value within 1 Mb of the gene
locus,</p></li>
<li><p>and the P-value corresponding to this GWAS SNP.</p></li>
</ol>
<p>The permutation test test assesses how much signal is added by
isoform expression, given the GWAS architecture of the locus, and
controls for large LD blocks. We shuffle the SNP-to-isoform weights to
generate a null distribution and use this null to generate the
permutation P-value. We only run this permutation test if the nominal
P-value from the isoform-level Z-score is less than <code>alpha</code>,
as defined in the <code>burdenTest</code> function.</p>
</div>
<div class="section level2">
<h2 id="stage-wise-hypothesis-test">Stage-wise hypothesis test<a class="anchor" aria-label="anchor" href="#stage-wise-hypothesis-test"></a>
</h2>
<p><code>isoTWAS</code> employs a two-step testing framework. First, we
control from false discovery rate (FDR) across gene families, using
either Benjamini-Hochberg FDR control (recommended) or Bonferroni. Next,
for genes that pass FDR control (adjusted P-values for the genes are
lower than our defined significance threshold), we drop down to the
isoform level and run family-wise error rate (FWER) control using
Shaffer’s modified sequentially rejective Bonferroni procedure. Here, we
are controlling both the FDR (<code>alpha1</code>) and FWER
(<code>alpha2</code>) to 0.05.</p>
<p>Let’s run the first stage now: gene-level FDR control.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gene</span> <span class="op">=</span> <span class="va">out_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Gene</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Screen.P <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/p_screen.html">p_screen</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              Gene     Screen.P</span></span>
<span><span class="co">## 1 ENSG00000070831 0.0016636386</span></span>
<span><span class="co">## 2 ENSG00000162552 0.0008302377</span></span>
<span><span class="co">## 3 ENSG00000230068 0.0004539979</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha1</span><span class="op">=</span><span class="fl">.05</span></span>
<span><span class="va">G</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="va">gene</span><span class="op">$</span><span class="va">Screen.P.Adjusted</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">gene</span><span class="op">$</span><span class="va">Screen.P</span>,method <span class="op">=</span> <span class="st">'fdr'</span><span class="op">)</span></span>
<span><span class="va">R</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">gene</span><span class="op">$</span><span class="va">Gene</span><span class="op">[</span><span class="va">gene</span><span class="op">$</span><span class="va">Screen.P.Adjusted</span> <span class="op">&lt;</span> <span class="va">alpha1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">alpha2</span> <span class="op">=</span> <span class="op">(</span><span class="va">R</span><span class="op">*</span><span class="va">alpha1</span><span class="op">)</span><span class="op">/</span><span class="va">G</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              Gene     Screen.P Screen.P.Adjusted</span></span>
<span><span class="co">## 1 ENSG00000070831 0.0016636386       0.001663639</span></span>
<span><span class="co">## 2 ENSG00000162552 0.0008302377       0.001245357</span></span>
<span><span class="co">## 3 ENSG00000230068 0.0004539979       0.001245357</span></span></code></pre>
<p>We see that, on the gene-level, all 3 genes pass FDR control. That
is, we see that the adjusted screening P-value is less than 0.05 for all
3 genes. Now, we have to drop down to the isoform level for all 3
genes.</p>
<p>Let’s run the second stage: isoform-level FWER control for these gene
families.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">isoform_new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                   ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">out_df</span><span class="op">)</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">isoform_new</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">out_df</span><span class="op">)</span>,<span class="st">'Screen.P'</span>,<span class="st">'Confirmation.P'</span><span class="op">)</span></span>
<span><span class="va">gene</span> <span class="op">=</span> <span class="va">gene</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">gene</span><span class="op">$</span><span class="va">Screen.P</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">ttt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">out_df</span>,</span>
<span>            <span class="va">gene</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Gene'</span>,<span class="st">'Screen.P'</span>,</span>
<span>                    <span class="st">'Screen.P.Adjusted'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            by <span class="op">=</span> <span class="st">'Gene'</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">isoform_new</span> <span class="op">=</span> <span class="va">ttt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Gene</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Feature <span class="op">=</span> <span class="va">Feature</span>,</span>
<span>            Confirmation.P <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/p_confirm.html">p_confirm</a></span><span class="op">(</span><span class="va">P</span>,alpha <span class="op">=</span> <span class="va">alpha2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `summarise()` has grouped output by 'Gene'. You can override using the</span></span>
<span><span class="co">## `.groups` argument.</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">isoform_new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">isoform_new</span>,<span class="va">ttt</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Gene'</span>,<span class="st">'Feature'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">isoform_new</span><span class="op">$</span><span class="va">Confirmation.P</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">isoform_new</span><span class="op">$</span><span class="va">Screen.P.Adjusted</span> <span class="op">&lt;</span> <span class="fl">0.05</span>,</span>
<span>                                    <span class="va">isoform_new</span><span class="op">$</span><span class="va">Confirmation.P</span>,</span>
<span>                                    <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">isoform_new</span> <span class="op">=</span> <span class="va">isoform_new</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Gene'</span>,<span class="st">'Feature'</span>,<span class="st">'Z'</span>,<span class="st">'P'</span>,<span class="st">'permute.P'</span>,</span>
<span>                             <span class="st">'topSNP'</span>,<span class="st">'topSNP.P'</span>,</span>
<span>                             <span class="st">'Screen.P'</span>,<span class="st">'Screen.P.Adjusted'</span>,<span class="st">'Confirmation.P'</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">isoform_new</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               Gene         Feature         Z            P   permute.P</span></span>
<span><span class="co">## 1  ENSG00000070831 ENST00000315554  1.268410 0.2046514827 1.000000000</span></span>
<span><span class="co">## 2  ENSG00000070831 ENST00000344548 -3.239210 0.0011986108 1.000000000</span></span>
<span><span class="co">## 3  ENSG00000070831 ENST00000400259  3.344840 0.0008232993 0.011988012</span></span>
<span><span class="co">## 4  ENSG00000070831 ENST00000498236 -2.906460 0.0036554386 1.000000000</span></span>
<span><span class="co">## 5  ENSG00000070831 ENST00000656825  3.268385 0.0010816323 1.000000000</span></span>
<span><span class="co">## 6  ENSG00000070831 ENST00000662562 -3.278162 0.0010448529 1.000000000</span></span>
<span><span class="co">## 7  ENSG00000070831 ENST00000667384  0.575199 0.5651567515 1.000000000</span></span>
<span><span class="co">## 8  ENSG00000162552 ENST00000290167 -3.441877 0.0005776926 0.041958042</span></span>
<span><span class="co">## 9  ENSG00000162552 ENST00000415567 -3.179540 0.0014750883 1.000000000</span></span>
<span><span class="co">## 10 ENSG00000230068 ENST00000431803 -3.506525 0.0004539979 0.007992008</span></span>
<span><span class="co">##        topSNP     topSNP.P     Screen.P Screen.P.Adjusted Confirmation.P</span></span>
<span><span class="co">## 1  rs11582542 0.0003396706 0.0016636386       0.001663639   1.0000000000</span></span>
<span><span class="co">## 2   rs2143103 0.0004331767 0.0016636386       0.001663639   0.0062691173</span></span>
<span><span class="co">## 3  rs11582542 0.0003396706 0.0016636386       0.001663639   0.0049397958</span></span>
<span><span class="co">## 4  rs11582542 0.0003396706 0.0016636386       0.001663639   0.0109663157</span></span>
<span><span class="co">## 5  rs11582542 0.0003396706 0.0016636386       0.001663639   0.0062691173</span></span>
<span><span class="co">## 6   rs2143103 0.0004331767 0.0016636386       0.001663639   0.0062691173</span></span>
<span><span class="co">## 7  rs11582542 0.0003396706 0.0016636386       0.001663639   1.0000000000</span></span>
<span><span class="co">## 8  rs11582542 0.0003396706 0.0008302377       0.001245357   0.0005776926</span></span>
<span><span class="co">## 9  rs11582542 0.0003396706 0.0008302377       0.001245357   0.0014750883</span></span>
<span><span class="co">## 10 rs11582542 0.0003396706 0.0004539979       0.001245357   0.0000000000</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">isoform_new</span>,<span class="va">Screen.P.Adjusted</span> <span class="op">&lt;</span> <span class="va">alpha1</span> <span class="op">&amp;</span></span>
<span>               <span class="va">Confirmation.P</span> <span class="op">&lt;</span> <span class="va">alpha2</span> <span class="op">&amp;</span></span>
<span>               <span class="va">permute.P</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               Gene         Feature         Z            P   permute.P</span></span>
<span><span class="co">## 3  ENSG00000070831 ENST00000400259  3.344840 0.0008232993 0.011988012</span></span>
<span><span class="co">## 8  ENSG00000162552 ENST00000290167 -3.441877 0.0005776926 0.041958042</span></span>
<span><span class="co">## 10 ENSG00000230068 ENST00000431803 -3.506525 0.0004539979 0.007992008</span></span>
<span><span class="co">##        topSNP     topSNP.P     Screen.P Screen.P.Adjusted Confirmation.P</span></span>
<span><span class="co">## 3  rs11582542 0.0003396706 0.0016636386       0.001663639   0.0049397958</span></span>
<span><span class="co">## 8  rs11582542 0.0003396706 0.0008302377       0.001245357   0.0005776926</span></span>
<span><span class="co">## 10 rs11582542 0.0003396706 0.0004539979       0.001245357   0.0000000000</span></span></code></pre>
<p>We have now generated screening gene-level FDR-adjusted P-values and
confirmation isoform-level FWER controlled P-values. We see that there
are 3 isoforms at this locus that pass all 3 levels of hypothesis
testing: screening FDR-adjusted P &lt; 0.05, confirmation FWER-adjusted
P &lt; 0.05, and nominal permutation P &lt; 0.05. These isoforms are
ENST00000400259 (gene: <em>ENSG00000070831</em>), ENST00000290167 (gene:
<em>ENSG00000162552</em>), and ENST00000431803 (gene:
<em>ENSG00000230068</em>).</p>
</div>
<div class="section level2">
<h2 id="fine-mapping-overlapping-and-trait-associated-isoforms">Fine-mapping overlapping and trait-associated isoforms<a class="anchor" aria-label="anchor" href="#fine-mapping-overlapping-and-trait-associated-isoforms"></a>
</h2>
<p>Since these two isoforms overlap and likely share LD-linked SNPs that
predict each isoform, we can’t be sure which of the three isoforms are
likely to be carrying the trait association signal. In short, we account
of the correlations between the genetically-predicted portions of the
expression of these isoforms, enumerate the possible causal
configurations, and use a Bayesian approach to generate a posterior
inclusion probability (PIP) for each isoform. These PIPs can be used to
generate a 90% credible set of isoforms that best explain the trait
association at the locus. See <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6619422/" class="external-link">Mancuso et
al’s manuscript</a> about gene-level fine-mapping for more of the
intuition and mathematical details.</p>
<p>For fine-mapping, you no longer need the GWAS summary statistics. You
will need:</p>
<ol style="list-style-type: decimal">
<li><p>TWAS summary statistics (something that looks like
<code>isoform_new</code>),</p></li>
<li><p>the isoTWAS models, and</p></li>
<li><p>an LD reference panel.</p></li>
</ol>
<p>Here, you need to make sure the LD reference matrix contains
<strong>all SNPs that are in all models for all isoforms in the
overlapping locus</strong>. If you do not have the in-sample
individual-level genotypes, we recommend using 1000 Genomes. For ease in
this tutorial, we have compiled the necessary LD matrix.</p>
<p>First, we annotate each isoform with location and select the
significantly associated isoforms that are within 1 Mb of one another.
We can obtain the gene annotation with the following code:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">biomaRt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gene_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">isoform_new</span><span class="op">$</span><span class="va">Gene</span><span class="op">)</span></span>
<span><span class="va">ensembl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/biomaRt/man/useEnsembl.html" class="external-link">useEnsembl</a></span><span class="op">(</span>biomart <span class="op">=</span> <span class="st">"ensembl"</span>, </span>
<span>                   dataset <span class="op">=</span> <span class="st">"hsapiens_gene_ensembl"</span>, </span>
<span>                   mirror <span class="op">=</span> <span class="st">"useast"</span><span class="op">)</span></span>
<span><span class="va">bm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/biomaRt/man/getBM.html" class="external-link">getBM</a></span><span class="op">(</span>attributes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ensembl_gene_id'</span>, </span>
<span>                          <span class="st">'chromosome_name'</span>,</span>
<span>                          <span class="st">'start_position'</span>,</span>
<span>                          <span class="st">'end_position'</span><span class="op">)</span>,</span>
<span>      filters <span class="op">=</span> <span class="st">'ensembl_gene_id'</span>,</span>
<span>      values <span class="op">=</span> <span class="va">gene_names</span>, </span>
<span>      mart <span class="op">=</span> <span class="va">ensembl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Gene'</span>,<span class="st">'Chromosome'</span>,<span class="st">'Start'</span>,<span class="st">'End'</span><span class="op">)</span></span></code></pre></div>
<p>Next, we select the overlapping isoforms.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Gene <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ENSG00000070831'</span>,<span class="st">'ENSG00000162552'</span>,<span class="st">'ENSG00000230068'</span><span class="op">)</span>,</span>
<span>                Chromosome <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                Start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22052627</span>,<span class="fl">22117313</span>,<span class="fl">22059197</span><span class="op">)</span>,</span>
<span>                End <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22101360</span>,<span class="fl">22143969</span>,<span class="fl">22064199</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">isoform_new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">bm</span>,<span class="va">isoform_new</span>,by<span class="op">=</span><span class="st">'Gene'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">isoform_new</span> <span class="op">=</span> <span class="va">isoform_new</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">isoform_new</span><span class="op">$</span><span class="va">Chromosome</span>,</span>
<span>                                <span class="va">isoform_new</span><span class="op">$</span><span class="va">Start</span>,</span>
<span>                                decreasing <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">isoform_sig</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">isoform_new</span>,</span>
<span>                     <span class="va">Screen.P.Adjusted</span> <span class="op">&lt;</span> <span class="va">alpha1</span> <span class="op">&amp;</span></span>
<span>                       <span class="va">Confirmation.P</span> <span class="op">&lt;</span> <span class="va">alpha2</span> <span class="op">&amp;</span></span>
<span>                       <span class="va">permute.P</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="va">keep.isoform</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">End</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">isoform_sig</span><span class="op">$</span><span class="va">Start</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1e6</span><span class="op">)</span><span class="op">{</span></span>
<span>          <span class="va">keep.isoform</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">keep.isoform</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">Feature</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">i</span>,<span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">isoform_sig</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">isoform_sig</span>,<span class="va">Feature</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">keep.isoform</span><span class="op">)</span></span></code></pre></div>
<p>Significant isoforms that do not overlap within 1 Mb of another
significant isoform do not need to be fine-mapped.</p>
<p>Now, we aggregate the models and generate a single table with the
SNP-to-isoform weights of all the SNPs that predict these overlapping
isoforms.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.snps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">omega</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">snp.chr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### COLLECT WEIGHTS FOR SNPS IN THE MODELS</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">gene_in</span> <span class="op">=</span> <span class="va">isoform_sig</span><span class="op">$</span><span class="va">Gene</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">model_in</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">gene_in</span>,<span class="st">"_isoTWAS.RDS"</span><span class="op">)</span>,</span>
<span>                              package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">model_in</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">model_in</span>,</span>
<span>                    <span class="va">Feature</span> <span class="op">==</span> <span class="va">isoform_sig</span><span class="op">$</span><span class="va">Feature</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>SNP <span class="op">=</span> <span class="va">model_in</span><span class="op">$</span><span class="va">SNP</span>,</span>
<span>                     Chromosome <span class="op">=</span> <span class="va">model_in</span><span class="op">$</span><span class="va">Chromosome</span>,</span>
<span>                     Position <span class="op">=</span> <span class="va">model_in</span><span class="op">$</span><span class="va">Position</span>,</span>
<span>                     Effect <span class="op">=</span> <span class="va">model_in</span><span class="op">$</span><span class="va">Weight</span>,</span>
<span>                     A1 <span class="op">=</span> <span class="va">model_in</span><span class="op">$</span><span class="va">ALT</span>,</span>
<span>                     A2 <span class="op">=</span> <span class="va">model_in</span><span class="op">$</span><span class="va">REF</span><span class="op">)</span></span>
<span>  <span class="va">Model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Model</span>,<span class="va">Effect</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">Model</span> <span class="op">=</span> <span class="va">Model</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">Model</span><span class="op">$</span><span class="va">SNP</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">all.snps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">all.snps</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">Model</span><span class="op">$</span><span class="va">SNP</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">omega</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">omega</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Model</span><span class="op">$</span><span class="va">Effect</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gene</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gene</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">Feature</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">snp.chr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">snp.chr</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Model</span><span class="op">$</span><span class="va">Chromosome</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pos</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Model</span><span class="op">$</span><span class="va">Position</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">tot.df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>SNP <span class="op">=</span> <span class="va">all.snps</span>,</span>
<span>                    Gene <span class="op">=</span> <span class="va">gene</span>,</span>
<span>                    Effect <span class="op">=</span> <span class="va">omega</span>,</span>
<span>                    Chromosome <span class="op">=</span> <span class="va">snp.chr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model.df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.snps</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">model.df</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'SNP'</span>,<span class="va">isoform_sig</span><span class="op">$</span><span class="va">Feature</span><span class="op">)</span></span>
<span><span class="va">model.df</span><span class="op">$</span><span class="va">SNP</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.snps</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">q</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">cur.tot.df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">tot.df</span>,<span class="va">Gene</span> <span class="op">==</span> <span class="va">isoform_sig</span><span class="op">$</span><span class="va">Feature</span><span class="op">[</span><span class="va">q</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">cur.tot.df</span><span class="op">$</span><span class="va">SNP</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">cur.tot.df</span><span class="op">$</span><span class="va">SNP</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">model.df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">cur.tot.df</span><span class="op">$</span><span class="va">SNP</span> <span class="op">==</span> <span class="va">model.df</span><span class="op">$</span><span class="va">SNP</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">model.df</span><span class="op">[</span><span class="va">i</span>,<span class="va">q</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span>,</span>
<span>                             <span class="va">cur.tot.df</span><span class="op">$</span><span class="va">Effect</span><span class="op">[</span><span class="va">w</span><span class="op">]</span>,</span>
<span>                             <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">model.df</span><span class="op">$</span><span class="va">Chromosome</span> <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">model.df</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rrr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">tot.df</span>,<span class="va">SNP</span> <span class="op">==</span> <span class="va">model.df</span><span class="op">$</span><span class="va">SNP</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">model.df</span><span class="op">$</span><span class="va">Chromosome</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">rrr</span><span class="op">$</span><span class="va">Chromosome</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">model.df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          SNP ENST00000400259 ENST00000431803 ENST00000290167 Chromosome</span></span>
<span><span class="co">## 1  rs1002480   -3.437902e-04    8.726253e-05               0          1</span></span>
<span><span class="co">## 2  rs1011380   -5.231286e-05    8.881914e-05               0          1</span></span>
<span><span class="co">## 3  rs1014986    7.976357e-05    1.177811e-03               0          1</span></span>
<span><span class="co">## 4 rs10157808    2.620658e-04    2.047407e-05               0          1</span></span>
<span><span class="co">## 5  rs1018102    4.699228e-05    1.019356e-04               0          1</span></span>
<span><span class="co">## 6 rs10218584   -6.270159e-05    3.580614e-06               0          1</span></span></code></pre>
<p>This step generates a data frame in <code>model.df</code> that
includes all SNPs in both isoTWAS models at the locus and their effect
(non-zero or otherwise) on each isoforms we are fine-mapping at the
locus.</p>
<p>Now, we obtain our LD matrix for the SNPs in
<code>model.df$SNP</code></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">V</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                        <span class="st">"test_LD_finemapping.RDS"</span>,</span>
<span>                        package <span class="op">=</span> <span class="st">"isotwas"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, we run the fine-mapping process in the following steps: (1)
compute the correlation between the genetically-predicted expression of
the isoforms, (2) enumerate the causal configurations, (3) compute
marginal likelihoods and Bayes factors for each isoform, and (4) compute
posterior inclusion probabilities and credible sets.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">V</span> <span class="op">=</span> <span class="va">V</span><span class="op">[</span><span class="va">model.df</span><span class="op">$</span><span class="va">SNP</span>,<span class="va">model.df</span><span class="op">$</span><span class="va">SNP</span><span class="op">]</span></span>
<span><span class="va">Omega</span> <span class="op">=</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">model.df</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">model.df</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">zscores</span> <span class="op">=</span> <span class="va">isoform_sig</span><span class="op">$</span><span class="va">Z</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">zscores</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### COMPUTE LD BETWEEN TX ON THE GENETIC LEVEL</span></span>
<span><span class="va">wcor</span> <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/estimate_cor.html">estimate_cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Omega</span><span class="op">)</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span>,</span>
<span>                             intercept<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">wcor</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">wcor</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wcor</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co">### COMPUTE LD INTERCEPT BETWEEN ISOFRM ON THE GENETIC LEVEL</span></span>
<span><span class="va">swld</span> <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/estimate_cor.html">estimate_cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">Omega</span><span class="op">)</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span>,</span>
<span>                             intercept<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>        </span>
<span><span class="va">null_res</span> <span class="op">=</span> <span class="va">m</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">1e-3</span><span class="op">)</span></span>
<span><span class="va">marginal</span> <span class="op">=</span> <span class="va">m</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">1e-3</span><span class="op">)</span></span>
<span><span class="va">comb_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">zscores</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">comb_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">comb_list</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/utils/combn.html" class="external-link">combn</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">zscores</span><span class="op">)</span>,<span class="va">n</span>,simplify<span class="op">=</span><span class="cn">F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">pips</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">zscores</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### COMPUTE BAYES FACTORS/LIKELIHOOD AT EACH CAUSAL CONFIG</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">comb_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">subset</span> <span class="op">=</span> <span class="va">comb_list</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">local</span> <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/bayes_factor.html">bayes_factor</a></span><span class="op">(</span><span class="va">zscores</span>,</span>
<span>                                idx_set <span class="op">=</span> <span class="va">subset</span>,</span>
<span>                                wcor <span class="op">=</span> <span class="va">wcor</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">marginal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">local</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">marginal</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">idx</span> <span class="kw">in</span> <span class="va">subset</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">pips</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">pips</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">=</span> <span class="va">local</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">pips</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">pips</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">local</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">pips</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">pips</span> <span class="op">-</span> <span class="va">marginal</span><span class="op">)</span></span>
<span><span class="va">null_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">null_res</span> <span class="op">-</span> <span class="va">marginal</span><span class="op">)</span></span>
<span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">pip</span> <span class="op">=</span> <span class="va">pips</span></span>
<span><span class="va">isoform_sig</span> <span class="op">=</span> <span class="va">isoform_sig</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">pip</span>,decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">npost</span> <span class="op">=</span> <span class="va">isoform_sig</span><span class="op">$</span><span class="va">pip</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">pip</span><span class="op">)</span></span>
<span><span class="va">csum</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">npost</span><span class="op">)</span></span>
<span><span class="va">isoform_sig</span><span class="op">$</span><span class="va">in_cred_set</span> <span class="op">=</span> <span class="cn">F</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">isoform_sig</span><span class="op">$</span><span class="va">in_cred_set</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="cn">T</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">csum</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">.9</span> <span class="op">&amp;</span> <span class="va">csum</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.9</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">isoform_sig</span><span class="op">$</span><span class="va">in_cred_set</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="cn">T</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">csum</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.9</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">isoform_sig</span><span class="op">$</span><span class="va">in_cred_set</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="cn">T</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">csum</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">.9</span> <span class="op">&amp;</span> <span class="va">csum</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">.9</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">isoform_sig</span><span class="op">$</span><span class="va">in_cred_set</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="cn">F</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">isoform_sig</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               Gene Chromosome    Start      End         Feature         Z</span></span>
<span><span class="co">## 3  ENSG00000070831          1 22052627 22101360 ENST00000400259  3.344840</span></span>
<span><span class="co">## 10 ENSG00000230068          1 22059197 22064199 ENST00000431803 -3.506525</span></span>
<span><span class="co">## 8  ENSG00000162552          1 22117313 22143969 ENST00000290167 -3.441877</span></span>
<span><span class="co">##               P   permute.P     topSNP     topSNP.P     Screen.P</span></span>
<span><span class="co">## 3  0.0008232993 0.011988012 rs11582542 0.0003396706 0.0016636386</span></span>
<span><span class="co">## 10 0.0004539979 0.007992008 rs11582542 0.0003396706 0.0004539979</span></span>
<span><span class="co">## 8  0.0005776926 0.041958042 rs11582542 0.0003396706 0.0008302377</span></span>
<span><span class="co">##    Screen.P.Adjusted Confirmation.P          pip in_cred_set</span></span>
<span><span class="co">## 3        0.001663639   0.0049397958 1.000000e+00        TRUE</span></span>
<span><span class="co">## 10       0.001245357   0.0000000000 1.000000e+00        TRUE</span></span>
<span><span class="co">## 8        0.001245357   0.0005776926 1.419146e-18       FALSE</span></span></code></pre>
<p>As you can see, ENST00000431803 and ENST00000290167 have
<code>PIP = 1</code> and are both in the 90% credible set
(<code>in_cred_set</code> column).</p>
<p>Full scripts for association testing genome-wide are available <a href="https://github.com/bhattacharya-a-bt/isotwas_manu_scripts" class="external-link">here</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Arjun Bhattacharya.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
