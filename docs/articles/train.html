<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="isotwas">
<title>Train an isotwas model • isotwas</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Train an isotwas model">
<meta property="og:description" content="isotwas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">isotwas</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/train.html">Train an isotwas model</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Train an isotwas model</h1>
            
      
      
      <div class="d-none name"><code>train.Rmd</code></div>
    </div>

    
    
<p>This module will cover how to use functions from <code>isotwas</code> to train an multivariate isotwas model for isoform-level expression. Along the way, we’ll be covering some practical considerations for computation and feature selection.</p>
<p>To train a multivariate model, we need:</p>
<ol style="list-style-type: decimal">
<li><p>a matrix of dosages of SNPs, and</p></li>
<li><p>a matrix of isoform-level expressions for a given gene.</p></li>
</ol>
<p>Isoform expression estimated from pseudo-alignment methods like <a href="https://combine-lab.github.io/salmon/" class="external-link"><code>salmon</code></a> and <a href="https://pachterlab.github.io/kallisto/" class="external-link"><code>kallisto</code></a> provide bootstrapped estimates expression across a number of iterations. This information can be included into model training, as illustrated below.</p>
<p><u><strong>Practical consideration</strong></u>: Ideally, to reduce your memory usage, we recommend storing your genetic data as <code>PLINK</code> format data (ideally as <code>.bed</code>/<code>bim</code>/<code>fam</code> or <code>.pgen</code>/<code>.pvar</code>/<code>.psam</code>). For a given gene, use <code>PLINK</code> to <a href="https://www.cog-genomics.org/plink/2.0/filter" class="external-link">select only SNPs</a> on the same chromosome and within 1 Megabase of the gene body. Then, you can use the <a href="https://privefl.github.io/bigsnpr/" class="external-link"><code>bigsnpr</code> package</a> read in this “condensed” file set.</p>
<p>For this vignette, we’ll generate some toy genetic and transcriptomic data with <span class="math inline">\(p = 3\)</span> isoforms for a gene and <span class="math inline">\(k = 500\)</span> SNPs within 1 Megabase of the gene across <span class="math inline">\(n = 200\)</span> samples.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">=</span> <span class="fl">3</span>; <span class="va">k</span> <span class="op">=</span> <span class="fl">500</span>; <span class="va">n</span> <span class="op">=</span> <span class="fl">200</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1789</span><span class="op">)</span> 
<span class="va">maf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">k</span>,<span class="fl">0.05</span>,<span class="fl">0.5</span><span class="op">)</span> 
<span class="va">gen_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">maf</span>,<span class="kw">function</span><span class="op">(</span><span class="va">freq</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">2</span>,<span class="va">freq</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">gen_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sample'</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">gen_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'SNP'</span>,<span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">gen_mat</span><span class="op">)</span>
<span class="co">#&gt; [1] 200 500</span></code></pre></div>
<p>This generates a <span class="math inline">\(200 \times 500\)</span> SNP matrix saved to gen_mat. These SNPs are coded as 0, 1, and 2, where the <span class="math inline">\(ij\)</span>-th element of gen_mat represents the number of alternative alleles at SNP <span class="math inline">\(j\)</span> for sample <span class="math inline">\(i\)</span>.</p>
<p>Now, let’s make our matrix of isoform expression (call it <code>isoform_mat</code>) that is the product of the SNP matrix gen_mat and a sparse isoform effect matrix (<code>b_isoqtl</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1789</span><span class="op">)</span> 
<span class="va">isoform_mat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">k</span><span class="op">)</span> 
<span class="va">effects</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">k</span><span class="op">*</span><span class="va">p</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> 
<span class="va">effects</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">k</span><span class="op">*</span><span class="va">p</span>,<span class="fl">1</span>,<span class="fl">0.01</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span> 
<span class="va">b_isoqtl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">effects</span>, nrow <span class="op">=</span> <span class="va">k</span><span class="op">)</span>

<span class="va">isoform_mat</span> <span class="op">=</span> <span class="va">gen_mat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b_isoqtl</span> 
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">isoform_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sample'</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">isoform_mat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Isoform'</span>,<span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">isoform_mat</span><span class="op">)</span>
<span class="co">#&gt; [1] 200   3</span></code></pre></div>
<p><u><strong>Practical consideration</strong></u>: Though this is not a requirement for the isotwas pipeline, we recommend a feature selection step based on cis-heritability of isoform-level expression. Prior of model training for isoforms of a given gene, we recommend that users compute the heritability of all expressed isoforms of a gene using <a href="https://yanglab.westlake.edu.cn/software/gcta/#Overview" class="external-link"><code>GCTA</code></a> (ideally the <a href="http://gusevlab.org/projects/fusion/" class="external-link"><code>gcta-nr-robust</code> executable in <code>FUSION</code></a>). We recommend users only train models for isoforms that have positive heritability at nominal <span class="math inline">\(P &lt; 0.05\)</span> or <span class="math inline">\(0.01\)</span>.</p>
<p><u><strong>Practical consideration</strong></u>: Prior to heritability analysis and model training, it is imperative that your expression data is residualized by relevant covariates (i.e. principal components of genotype matrix, hidden covariates or PEER factors of the expression matrix, clinical/demographic covariates). A general rule of thumb is if you would include the covariate in an eQTL/isoform-level eQTL analysis, you should include it in the residualization process.</p>
<p>Let’s jitter our expression matrix a little to generate 10 bootstrapped estimates of the matrix. Keep in mind that these replicates, theoretically, should not affect the effect size estimates but will help in seeding the estimation process of the correlation between isoforms/error in the multivariate model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">boot_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">isoform_mat</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> 
<span class="va">isoform_mat_rep</span> <span class="op">=</span> <span class="fu">rlist</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rlist/man/list.rbind.html" class="external-link">list.rbind</a></span><span class="op">(</span><span class="va">boot_list</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">isoform_mat_rep</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sample'</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span>,<span class="fl">10</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">isoform_mat_rep</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Isoform'</span>,<span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">isoform_mat_rep</span><span class="op">)</span>
<span class="co">#&gt; [1] 2000    3</span></code></pre></div>
<p>Now, we can train the model using the <code><a href="../reference/compute_isotwas.html">compute_isotwas()</a></code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">isotwas_model</span> <span class="op">=</span> <span class="fu">isotwas</span><span class="fu">::</span><span class="fu"><a href="../reference/compute_isotwas.html">compute_isotwas</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">gen_mat</span>, 
                                         Y <span class="op">=</span> <span class="va">isoform_mat</span>, 
                                         Y.rep <span class="op">=</span> <span class="va">isoform_mat_rep</span>,
                                         R <span class="op">=</span> <span class="fl">10</span>, 
                                         id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">isoform_mat_rep</span><span class="op">)</span>, 
                                         omega_est <span class="op">=</span> <span class="st">'replicates'</span>, 
                                         omega_nlambda <span class="op">=</span> <span class="fl">5</span>, 
                                         method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mrce_lasso'</span>, 
                                                    <span class="st">'multi_enet'</span>, 
                                                    <span class="st">'univariate'</span>,
                                                    <span class="st">'mvsusie'</span><span class="op">)</span>,
                                         predict_nlambda <span class="op">=</span> <span class="fl">10</span>, 
                                         family <span class="op">=</span> <span class="st">'gaussian'</span>, 
                                         scale <span class="op">=</span> <span class="cn">FALSE</span>, 
                                         alpha <span class="op">=</span> <span class="fl">0.5</span>, 
                                         nfolds <span class="op">=</span> <span class="fl">5</span>, 
                                         verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
                                         tx_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Isoform'</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, 
                                         seed <span class="op">=</span> <span class="fl">1789</span>, 
                                         run_all <span class="op">=</span> <span class="cn">FALSE</span>, 
                                         return_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>A few notes on the options in the function:</p>
<ul>
<li><p>By selecting <code>omega_est = 'replicates'</code> , we are used the bootstrapped replicates to estimate the correlation between isoforms to seed any methods that require this matrix. The alternative is <code>omega_est = 'mean'</code> , which will use whatever matrix you submit for <code>Y</code>.</p></li>
<li><p><code>omega_nlambda</code> selects the number of steps between fully dense to fully sparse in the correlation matrix estimation. We recommend 5-10 as the default here.</p></li>
<li><p>There are 6 total methods to predict expression. However, through simulations and real data examples, we recommend the four shown here as the default in the <code>method</code> option.</p></li>
<li><p><code>predict_nlambda</code> is the number of penalty variables that are considered from the <code>mrce_lasso</code> method. We recommend 10-20 for this variable.</p></li>
<li><p><code>family</code> and <code>alpha</code> are for <code>multi_enet</code> and <code>univariate</code> to determine how elastic net regression is run. The default is that the response follows a Normal distribution and the mixing parameter is set to 0.5.</p></li>
<li><p>If <code>run_all = TRUE</code>, then all 6 methods will be run.</p></li>
<li><p>If <code>return_all = TRUE</code>, then predicted values for each isoform and predictive performance for all methods and all isoforms will be outputted.</p></li>
</ul>
<p>We can convert the model from a list (the output from <code><a href="../reference/compute_isotwas.html">compute_isotwas()</a></code>) to a tibble or data.frame using <code>convert_model(isotwas_model)</code>.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Arjun Bhattacharya.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
